<!DOCTYPE html>

<html>
	<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
	<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
	<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
	<script>

    $(
    	function() {
		    
		    $("#artist_search").autocomplete(
		    	{
		    		'source': getSuggestions,
		    		'select': menuUsedForSelection
		    	}
		    ).keypress(
		    	function(e) {
		    		if (e.keyCode === 13) {
		    			enterUsedForSelection();		    			
			    	}
			    }
			);
		}
	);

	//search

    function getSuggestions(event, callback) {
    	var query = $("#artist_search").val();
    	console.log(query);  

    	var uri = "suggest?q=" + query;

    	var xhr = $.ajax( uri )
		.done(
			function (data) {
				console.log(data);    				
				callback(data);
			}
		).fail(
			function (e) {
				alert("FAIL");
				alert(e);
				callback([]);
			}
		);
    }

    function getArtistSpotifyInfo(callback, error, query) {
    	var uri = "artist?q=" + query;

    	var xhr = $.ajax( uri )
		.done(
			function (data) {
				console.log(data);    				
				callback(data);
			}
		).fail(
			function (e) {
				alert("FAIL");
				alert(e);
				callback([]);
			}
		);	
    }

    function getSimilarArtists(callback, error, query) {
    	var uri = "similar?q=" + query;

    	var xhr = $.ajax( uri )
		.done(
			function (data) {
				console.log(data);    				
				callback(data);
			}
		).fail(
			function (e) {
				alert("FAIL");
				alert(e);
				callback([]);
			}
		);	
    }

    function updatePlayer(spotifyUri) {
    	var uri = "http://embed.spotify.com/?uri=" + spotifyUri;
    	console.log(uri);
    	$("#spotify_widget").attr('src', uri);
    }

    function matchArtist(query, artists) {
    	var bestGuess = artists[0];
    	for (var i = artists.length - 1; i >= 0; i--) {
    		if (artists[i].name === query) {
    			bestGuess = artists[i];
    		}
    	};
    	return bestGuess;
    }

    function loadArtist(query) {
    	getArtistSpotifyInfo (    	
    		function (artists) {
    			console.log(artists);
    			var artist = matchArtist(query, artists);
    			var artistUri = artist.href;
    			console.log(artistUri);
    			updatePlayer(artistUri);
    			clearSimilarArtists();
    			loadSimilarArtists(
    				artist.name
    			);
    		},
    		function(e) {
    			console.log(e);
    			alrert(e);
    		},
    		query
    	);
    }


    function useSelection(query) {
    	console.log("Got to USE SELECTION");
    	console.log(query);
    	loadArtist(query);
    }

    function menuUsedForSelection(event, ui) {
    	var query = ui.item.value;
    	console.log(query);
    	useSelection(query);
    }

    function enterUsedForSelection() {
    	var query = $("#artist_search").val();
    	$("#artist_search").autocomplete("close");
    	console.log("Manually closed menu");
    	useSelection(query);
    }

	function makeSelection(query) {
		console.log("makeSelection");
		$("#artist_search").autocomplete("close");
		$("#artist_search").val(query);
		useSelection(query);
	}

	function clearSimilarArtists() {
		$("#similar_artists").find("tr").remove(); 		
	}

    function getSimilarArtistsHtml(artist) {
    	return '<tr><td>' + artist + '</td><td><a href="#" onclick="javascript:makeSelection(' + "'" + artist + "'" + '); return false;">Play</a></td></tr>';
    }

    function showSimilarArtists(artists) {
    	clearSimilarArtists();
    	var totalHtml = "";
    	for (var i = 0; i < artists.length; i++) {
    		var artist = artists[i];    		
    		totalHtml += getSimilarArtistsHtml(artist);
    	};
    	$("#similar_artists > tbody:last").after(totalHtml);
    }

    function loadSimilarArtists(query) {
    	getSimilarArtists(
    		function(artists) {
    			console.log(artists);
    			showSimilarArtists(artists);
    		},
    		function(e) {
    			console.log("oops");
    		},
    		query
    	);
    }

	</script>

	<body>

		<input id="artist_search" name="artist_search" type="text" value="" dir="ltr" spellcheck="false" />

		<br /><br /><br />

		<iframe id="spotify_widget" src="http://embed.spotify.com/?uri=spotify:artist:6olE6TJLqED3rqDCT0FyPh" width="300" height="380" frameborder="0" allowtransparency="true"></iframe>

		<table id="similar_artists">
			<tbody>
			</tbody>
		</table>

	</body>
</html>